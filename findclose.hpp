#ifndef SUCCINCT_TRIES__FINDCLOSE_HPP_
#define SUCCINCT_TRIES__FINDCLOSE_HPP_

#include <cstdint>
#include <x86intrin.h>
#include <cassert>

namespace strie {

// '(': 0, ')': 1
constexpr int8_t FINDCLOSE_TB[1<<8][9] { // [bitmask][#'(']
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 5, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 5, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 3, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 8, 8, 8, 8, 8, 8 },
    { 7, 0, 1, 2, 3, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 7, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 4, 8, 8, 8, 8, 8, 8, 8 },
    { 7, 0, 1, 4, 8, 8, 8, 8, 8 },
    { 3, 4, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 4, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 4, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 4, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 7, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 7, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 3, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 5, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 5, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 5, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 5, 8, 8, 8, 8 },
    { 5, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 5, 8, 8, 8, 8, 8, 8 },
    { 1, 4, 5, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 4, 5, 8, 8, 8, 8 },
    { 3, 4, 5, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 4, 5, 8, 8, 8, 8 },
    { 1, 2, 3, 4, 5, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 4, 5, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 5, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 5, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 3, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 4, 8, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 4, 8, 8, 8, 8, 8 },
    { 3, 4, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 4, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 4, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 4, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 6, 8, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 6, 8, 8, 8, 8, 8 },
    { 3, 6, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 6, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 6, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 6, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 6, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 6, 8, 8, 8, 8, 8 },
    { 5, 6, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 5, 6, 8, 8, 8, 8, 8 },
    { 1, 2, 5, 6, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 5, 6, 8, 8, 8 },
    { 5, 6, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 5, 6, 8, 8, 8, 8, 8 },
    { 1, 4, 5, 6, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 4, 5, 6, 8, 8, 8 },
    { 3, 4, 5, 6, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 4, 5, 6, 8, 8, 8 },
    { 1, 2, 3, 4, 5, 6, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 4, 5, 6, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 5, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 5, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 3, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 4, 8, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 4, 8, 8, 8, 8, 8 },
    { 3, 4, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 4, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 4, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 4, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 3, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 5, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 5, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 5, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 5, 8, 8, 8, 8 },
    { 5, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 5, 8, 8, 8, 8, 8, 8 },
    { 1, 4, 5, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 4, 5, 8, 8, 8, 8 },
    { 3, 4, 5, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 4, 5, 8, 8, 8, 8 },
    { 1, 2, 3, 4, 5, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 4, 5, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 8, 8, 8, 8, 8, 8, 8 },
    { 5, 0, 1, 2, 8, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 5, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 3, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 3, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 8, 8, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 7, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 7, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 7, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 7, 8, 8, 8, 8 },
    { 7, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 7, 8, 8, 8, 8, 8, 8 },
    { 1, 4, 7, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 4, 7, 8, 8, 8, 8 },
    { 3, 4, 7, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 4, 7, 8, 8, 8, 8 },
    { 1, 2, 3, 4, 7, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 4, 7, 8, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 8, 8, 8, 8, 8, 8 },
    { 7, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 7, 8, 8, 8, 8, 8, 8 },
    { 1, 2, 7, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 7, 8, 8, 8, 8 },
    { 7, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 7, 8, 8, 8, 8, 8, 8 },
    { 1, 6, 7, 8, 8, 8, 8, 8, 8 },
    { 8, 0, 1, 6, 7, 8, 8, 8, 8 },
    { 3, 6, 7, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 3, 6, 7, 8, 8, 8, 8 },
    { 1, 2, 3, 6, 7, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 3, 6, 7, 8, 8 },
    { 7, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 7, 8, 8, 8, 8, 8, 8 },
    { 1, 6, 7, 8, 8, 8, 8, 8, 8 },
    { 3, 0, 1, 6, 7, 8, 8, 8, 8 },
    { 5, 6, 7, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 5, 6, 7, 8, 8, 8, 8 },
    { 1, 2, 5, 6, 7, 8, 8, 8, 8 },
    { 8, 0, 1, 2, 5, 6, 7, 8, 8 },
    { 5, 6, 7, 8, 8, 8, 8, 8, 8 },
    { 1, 0, 5, 6, 7, 8, 8, 8, 8 },
    { 1, 4, 5, 6, 7, 8, 8, 8, 8 },
    { 8, 0, 1, 4, 5, 6, 7, 8, 8 },
    { 3, 4, 5, 6, 7, 8, 8, 8, 8 },
    { 1, 0, 3, 4, 5, 6, 7, 8, 8 },
    { 1, 2, 3, 4, 5, 6, 7, 8, 8 },
    { 8, 0, 1, 2, 3, 4, 5, 6, 7 },
};

size_t findclose64(uint64_t w) {
  size_t acc = w;
  // Popcnt foreach 8bits
  acc = (acc & 0x5555555555555555ull) + ((acc>>1) & 0x5555555555555555ull);
  acc = (acc & 0x3333333333333333ull) + ((acc>>2) & 0x3333333333333333ull);
  acc = (acc & 0x0F0F0F0F0F0F0F0Full) + ((acc>>4) & 0x0F0F0F0F0F0F0F0Full);
  // Forward accumulation
  acc *= 0x0101010101010101ull;
  // e = index-sum - 2 * acc
  acc *= 2;
  uint64_t e = (uint64_t) _mm_sub_pi8(_mm_set_pi8(64, 56, 48, 40, 32, 24, 16, 8),
                                      _mm_set_pi64x(acc));
  // Find findclose block
  uint64_t b = (uint64_t) _mm_sub_pi8(_mm_set_pi64x(e), _mm_set1_pi8(1));
  b &= 0x8080808080808080ull; // extract msb foreach 8bits
  b >>= 7;
  if (b == 0)
    return 64;
  // findclose is included in [o, o+8)
  auto o = _tzcnt_u64(b);
  auto s = o == 0 ? 0 : ((e >> (o-8)) & 0xFF) + 1;
  if (s == 0 and o > 0) {
    return o;
  }
  assert(FINDCLOSE_TB[w >> o & 0xFF][s] < 8);
  return o + FINDCLOSE_TB[w >> o & 0xFF][s];
}

} // strie

#endif //SUCCINCT_TRIES__FINDCLOSE_HPP_
